<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insulin Predictor</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <!-- Import Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* General Page Styling */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }

        /* Header Styling */
        header {
            background-color: #000;
            color: #fff;
            text-align: center;
            padding: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
        }

        /* Main Container */
        .container {
            display: flex;
            gap: 1rem;
            margin: 1rem;
        }

        /* Left Section: Recipes */
        .recipes {
            flex: 1;
            background-color: #fff;
            border-radius: 5px;
            padding: 1rem;
            box-shadow: 0 0 5px #aaa;
            max-width: 25%;
        }

        .recipes input {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .recipes button {
            width: 100%;
            background-color: #d3d3d3;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
        }

        .recipe-list {
            margin-top: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .recipe-item {
            border: 1px solid #e0e0e0;
            border-radius: 3px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        .recipe-item.selected {
            background-color: #e8f9e8;
            border: 1px solid #7cd67c;
        }

        /* Right Section: Graph & Details */
        .details {
            flex: 3;
            background-color: #fff;
            border-radius: 5px;
            padding: 1rem;
            box-shadow: 0 0 5px #aaa;
        }

        #glucoseChart {
            height: 300px;
            margin-bottom: 1rem;
        }

        .insulin-input {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        select, input {
            padding: 0.5rem;
        }

        .recipe-details {
            font-size: 1rem;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header>Insulin Predictor</header>

    <!-- Main Container -->
    <div class="container">
        <!-- Left Section: Recipe Input and List -->
        <div class="recipes">
            <input type="text" id="ingredientsInput" placeholder="Ingredient_1, ingredient2 ..." />
            <button id="generateRecipesBtn">GENERATE RECIPES</button>

            <!-- Recipe List -->
            <div class="recipe-list" id="recipeList">
                <!-- Recipes will be dynamically inserted here -->
            </div>
        </div>

        <!-- Right Section: Details and Chart -->
        <div class="details">
            <!-- Chart Section -->
            <canvas id="glucoseChart"></canvas>

            <!-- Insulin Input -->
            <div class="insulin-input">
                <label for="insulinDoses">Insulin Doses:</label>
                <select id="insulinDoses">
                    <option value="0">0</option>
                    <option value="0.5">0.5</option>
                    <option value="1">1</option>
                    <option value="1.5">1.5</option>
                    <option value="2">2</option>
                    <option value="2.5">2.5</option>
                    <option value="3">3</option>
                    <option value="3.5">3.5</option>
                    <option value="4">4</option>
                    <option value="4.5">4.5</option>
                    <option value="5">5</option>
                    <option value="5.5">5.5</option>
                    <option value="6">6</option>
                    <option value="6.5">6.5</option>
                    <option value="7">7</option>
                    <option value="7.5">7.5</option>
                    <option value="8">8</option>
                    <option value="8.5">8.5</option>
                    <option value="9">9</option>
                    <option value="9.5">9.5</option>
                    <option value="10">10</option>
                </select>
            </div>

            <!-- Recipe Details -->
            <div id="recipeDetails" class="recipe-details">
                <strong>RECIPE 1</strong>
                <p>Ingredients: ???</p>
                <p>Glycemic Index: 180</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Recipe and Chart Handling
        const generateRecipesBtn = document.getElementById("generateRecipesBtn");
        const recipeList = document.getElementById("recipeList");
        const glucoseChartCanvas = document.getElementById("glucoseChart");
        const recipeDetails = document.getElementById("recipeDetails");
        const insulinDoses = document.getElementById("insulinDoses");

        let glucoseChart; // Chart instance
        let recipes = []; // Store API response recipes

        console.log("Prova");

        // Function to fetch recipes based on ingredients
        async function fetchRecipes(ingredients) {
            try {
                const apiUrl = '/getRecipes';
        
                const requestBody = {
                    ingredients: ingredients,
                    count: 3
                };
        
                console.log(requestBody);
        
                // Fetch recipes
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
        
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
        
                const data = await response.json();
                console.log('Received recipe data:', data);
        
                // Fetch nutritional information for each recipe
                const recipesWithNutrition = await Promise.all(
                    data.recipes.map(async (recipe) => {
                        try {
                            const apiUrlNutritional = '/getRecipeInformation';

                            console.log(recipe);
        
                            const requestBodyNutritional = {
                                spoonRecipeID: recipe.SpoonRecipeID
                            };
        
                            const responseNutritional = await fetch(apiUrlNutritional, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(requestBodyNutritional)
                            });

                            console.log('Response Nutritional: ', responseNutritional);
        
                            if (!responseNutritional.ok) {
                                throw new Error(`HTTP error! Status: ${responseNutritional.status}`);
                            }
        
                            const dataNutritional = await responseNutritional.json();
                            console.log(`Nutritional data for recipe ${recipe.SpoonRecipeID}:`, dataNutritional);
        
                            // Extract carbohydrates
                            const carbos = dataNutritional.recipe.Nutrition?.find(nutrition => nutrition.name === 'Carbohydrates')?.amount || 0;
        
                            return {
                                id: recipe.SpoonRecipeID || 'N/A',
                                title: recipe.Title || 'N/A',
                                image: recipe.Image || 'N/A',
                                glycemicLoad: recipe.GlycemicLoad || 'N/A',
                                carbohydrates: carbos,
                                // Extract ingredient names and join them into a string
                                ingredients: recipe.Ingredients.map(ingredient => ingredient.Name).join(', ') || 'N/A'
                            };
        
                        } catch (error) {
                            console.error(`Error fetching nutritional data for recipe ${recipe.SpoonRecipeID}:`, error);
        
                            // Return the recipe without nutritional data in case of error
                            return {
                                id: recipe.SpoonRecipeID || 'N/A',
                                title: recipe.Title || 'N/A',
                                image: recipe.Image || 'N/A',
                                glycemicLoad: recipe.GlycemicLoad || 'N/A',
                                carbohydrates: 0, // Fallback value for carbohydrates
                                ingredients: recipe.Ingredients.map(ingredient => ingredient.Name).join(', ') || 'N/A'
                            };
                        }
                    })
                );
        
                return recipesWithNutrition;
        
            } catch (error) {
                console.error('Error fetching recipes:', error);
        
                // Return fallback data in case of error
                return [
                    { id: 1, title: "Fallback Recipe 1", ingredients: "Carrots, Rice", glycemicLoad: 180, carbohydrates: 0 },
                    { id: 2, title: "Fallback Recipe 2", ingredients: "Bread, Eggs", glycemicLoad: 160, carbohydrates: 0 },
                    { id: 3, title: "Fallback Recipe 3", ingredients: "Pasta, Cheese", glycemicLoad: 200, carbohydrates: 0 }
                ];
            }
        }
        

        // Event Listener: Generate Recipes
        generateRecipesBtn.addEventListener("click", async () => {
            const input = document.getElementById("ingredientsInput").value;
            const ingredients = input.split(',').map(ing => ing.trim());

            console.log(ingredients);

            if (ingredients.length === 0 || input.trim() === '') {
                alert("Please enter ingredients");
                return;
            }

            try {
                // Fetch recipes
                recipes = await fetchRecipes(ingredients);

                // Populate recipe list
                recipeList.innerHTML = "";
                recipes.forEach((recipe, index) => {
                    const recipeItem = document.createElement("div");
                    recipeItem.className = "recipe-item";
                    recipeItem.innerHTML = `
                        <strong>RECIPE ${index + 1}</strong><br>
                        Title: ${recipe.title}
                        Ingredients: ${recipe.ingredients}<br>
                        Glycemic Load: ${recipe.glycemicLoad}<br>
                        Carbohydrates: ${recipe.carbohydrates}<br>
                    `;
                    recipeItem.onclick = () => displayRecipeDetails(recipe, index, recipeItem);
                    recipeList.appendChild(recipeItem);
                });
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to fetch recipes');
            }
        });

        // Display Recipe Details and Update Chart
        function displayRecipeDetails(recipe, index, selectedItem) {
            // Highlight selected recipe
            document.querySelectorAll(".recipe-item").forEach(item => item.classList.remove("selected"));
            selectedItem.classList.add("selected");

            // Update recipe details
            recipeDetails.innerHTML = `
                <strong>RECIPE ${index + 1}: ${recipe.title || 'Unknown Recipe'}</strong>
                <p>Ingredients: ${recipe.ingredients}</p>
                <p>Glycemic Load: ${recipe.glycemicLoad}</p>
                ${recipe.image ? `<img src="${recipe.image}" alt="${recipe.title}" style="max-width: 100%;">` : ''}
            `;

            // Update glucose chart
            updateChart(recipe.carbohydrates);
        }

        // Update Chart with Glycemic Index
        /* function updateChart(glycemicIndex) {
            
            const insulinDose = insulinDosesSelect.value;

            const apiUrl = '/getGlucosePrediction';
                
            const requestBody = {
            };

            console.log(requestBody);

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });


            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const data = Array.from({ length: 10 }, (_, i) => glycemicIndex / insulinDose * Math.exp(-i / 2));

            if (glucoseChart) glucoseChart.destroy();

            glucoseChart = new Chart(glucoseChartCanvas, {
                type: "line",
                data: {
                    labels: Array.from({ length: 10 }, (_, i) => i),
                    datasets: [{
                        label: "Glucose Peak",
                        data: data,
                        borderColor: "rgba(75, 192, 192, 1)",
                        backgroundColor: "rgba(75, 192, 192, 0.2)",
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Initialize chart with default values
        updateChart(180); */

        async function updateChart(carbohydrates) {
            try {
                const insulinDose = parseFloat(insulinDoses.value) || 0;
                const carbInput = parseFloat(carbohydrates) || 0;
                
                const response = await fetch('/getGlucosePrediction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        insulin: insulinDose,
                        carbs: carbInput
                    })
                });
        
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
        
                const data = await response.json();
                
                // Find the last point of historical data to start prediction
                const lastHistoricalPoint = data.readings.glucose[data.readings.glucose.length - 1];
                
                // Create prediction data starting from the last historical point
                const predictionData = [lastHistoricalPoint, ...data.prediction.glucose];
                const predictionLabels = [data.readings.time[data.readings.time.length - 1], ...data.prediction.time];
                
                if (glucoseChart) {
                    glucoseChart.destroy();
                }
        
                glucoseChart = new Chart(glucoseChartCanvas, {
                    type: "line",
                    data: {
                        labels: data.readings.time,
                        datasets: [
                            {
                                label: "Glucose Data",
                                data: data.readings.glucose,
                                borderColor: "rgba(63, 81, 181, 1)",
                                backgroundColor: "rgba(63, 81, 181, 0.1)",
                                borderWidth: 2,
                                fill: false,
                                pointRadius: 0
                            },
                            {
                                label: "Glucose Prediction",
                                data: predictionData,
                                labels: predictionLabels,
                                borderColor: "rgba(244, 67, 54, 1)",
                                backgroundColor: "rgba(244, 67, 54, 0.1)",
                                borderWidth: 2,
                                fill: false,
                                pointRadius: 0,
                                borderDash: [5, 5]
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                min: 50,
                                max: 350,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error updating chart:', error);
                alert('Failed to update glucose prediction. Please try again.');
            }
        }
        
        // Add event listeners
        document.getElementById('insulinDoses').addEventListener('change', updateChart);
    </script>
</body>

</html>